TimeGraph={Graph:{BackgrundColor:"EDF3FE",Caption:"",SubCaption:"",XAxixTitle:"",YAxixTitle:"Hours",ShowaAimation:true,Data:[],Colors:["336699","FF8000","FFFF00","80FF00","FF0080","FF3D3D","FF7A7A","00FF00","FF00FF","7AFFFF","00FF80","8000FF","0000FF","0080FF","FF6600","FFE600","CCCC00","FF47FF","B85C00","33FF33","660000"],GenerateGraphXml:function(b){graphInfo=TimeGraph.Graph;var a=[],c=[];for(i=0;i<graphInfo.Data.length;i++){for(j=0;j<a.length;j++)if(graphInfo.Data[i].Category==a[j])break;j==a.length&&
a.push(graphInfo.Data[i].Category);for(j=0;j<c.length;j++)if(graphInfo.Data[i].Set==c[j])break;j==c.length&&c.push(graphInfo.Data[i].Set)}graphXml='<graph showNames="1" ';if(graphInfo.BackgrundColor)graphXml+=' bgcolor="'+graphInfo.BackgrundColor+'" ';if(graphInfo.Caption)graphXml+=' caption="'+graphInfo.Caption+'" ';if(graphInfo.SubCaption)graphXml+=' subcaption="'+graphInfo.SubCaption+'" ';if(graphInfo.XAxixTitle)graphXml+=' xAxisName="'+graphInfo.XAxixTitle+'" ';if(graphInfo.YAxixTitle)graphXml+=
' yAxisName="'+graphInfo.YAxixTitle+'" ';if(graphInfo.Data.length>12&&a.length==1)graphXml+=' rotateNames="1"  ';graphXml+=" > \n";if(a[0]!="Simple"){graphXml+='<categories font="Arial" fontSize="11" fontColor="000000"> \n';for(i=0;i<a.length;i++){categoryName=hoverText=a[i].replace(/["|']/gi,"");if(categoryName.length>20)categoryName=categoryName.substring(0,20)+"...";graphXml+='<category name="'+categoryName+'" hoverText="'+hoverText+'"  /> \n'}graphXml+="</categories> \n";for(i=0;i<c.length;i++){graphXml+=
'<dataset seriesname="'+c[i]+'" color="'+graphInfo.Colors[i%(graphInfo.Colors.length-1)]+'" alpha="100"> \n';for(j=0;j<a.length;j++){bMatchFound=false;for(k=0;k<graphInfo.Data.length;k++)if(a[j]==graphInfo.Data[k].Category&&c[i]==graphInfo.Data[k].Set){graphXml+='<set value="'+parseFloat(graphInfo.Data[k].Value).toFixed(2)+'" /> \n';bMatchFound=true;break}bMatchFound||(graphXml+='<set value="0" /> \n')}graphXml+="</dataset> \n"}}else for(i=0;i<graphInfo.Data.length;i++){setName=hoverText=graphInfo.Data[i].Set.replace(/["|']/gi,
"");if(setName.length>20)setName=setName.substring(0,20)+"...";graphXml+='<set name="'+setName+'" hoverText="'+hoverText+'" value="'+parseFloat(graphInfo.Data[i].Value).toFixed(2)+'" color="'+(b=="Line 2D Chart"?graphInfo.Colors[0]:graphInfo.Colors[i%(graphInfo.Colors.length-1)])+'" /> \n'}graphXml+="</graph> \n";return graphXml},getGraphJSONData:function(b){graphInfo=TimeGraph.Graph;jsonData={labels:[],datasets:[{data:[],backgroundColor:[],borderWidth:1}]};var a=[],c=[];for(i=0;i<graphInfo.Data.length;i++){for(j=
0;j<a.length;j++)if(graphInfo.Data[i].Category==a[j])break;j==a.length&&a.push(graphInfo.Data[i].Category);for(j=0;j<c.length;j++)if(graphInfo.Data[i].Set==c[j])break;j==c.length&&c.push(graphInfo.Data[i].Set)}if(a[0]=="Simple")for(i=0;i<graphInfo.Data.length;i++){setName=hoverText=graphInfo.Data[i].Set.replace(/["|']/gi,"");labelColor=b=="Line Chart"?graphInfo.Colors[0]:graphInfo.Colors[i%(graphInfo.Colors.length-1)];if(setName.length>20)setName=setName.substring(0,20)+"...";jsonData.labels.push(setName);
jsonData.datasets[0].backgroundColor.push("#"+labelColor);jsonData.datasets[0].data.push(parseFloat(graphInfo.Data[i].Value).toFixed(2))}return jsonData}},ReportData:{Data:null,Round:function(b,a){a=!a?2:a;return Math.round(b*Math.pow(10,a))/Math.pow(10,a)},GetWeekOfMonth:function(b){var a=b.getDate()-1;b=(new Date(b.getFullYear()+"/"+(b.getMonth()+1)+"/01")).getDay();return Math.ceil((a+b)/7)},NextDayOfMonth:function(b,a){for(month=b.getMonth();month==b.getMonth()&&b.getDay()!=a;)b.setDate(b.getDate()+
1);month!=b.getMonth()&&b.setDate(b.getDate()-1);return b},GetSeriesNameFromDate:function(b,a){seriesName="";months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];numSuffx=["st","nd","rd","th","th","th"];switch(b){case "Day":seriesName=a.getDate()+" "+months[a.getMonth()];break;case "Week":weekOfMonth=TimeGraph.ReportData.GetWeekOfMonth(a);seriesName=weekOfMonth+numSuffx[weekOfMonth-1]+" week of "+months[a.getMonth()];break;case "Month":seriesName=months[a.getMonth()]+" "+
a.getFullYear();break;case "Quarter":month=a.getMonth();seriesName=month<=3?"Jan-Mar "+a.getFullYear():month<=6?"Apr-Jun"+a.getFullYear():month<=9?"Jul-Sep"+a.getFullYear():"Oct-Nov"+a.getFullYear();break;case "Year":seriesName=a.getFullYear()+" ";break}return seriesName},SummarizeDataForGraph:function(b,a){var c=TimeGraph.ReportData.Data,d=[];c.sort(function(f,g){return f.Date<g.Date?-1:1});differenceDays=Math.ceil((c[c.length-1].Date.getTime()-c[0].Date.getTime())/864E5);var e="Day";e=b=="Simple"?
differenceDays<15?"Day":differenceDays<90?"Week":differenceDays<360?"Month":differenceDays<1E3?"Quarter":"Year":differenceDays<7?"Day":differenceDays<30?"Week":differenceDays<180?"Month":differenceDays<1E3?"Quarter":"Year";if(b=="Group by date"&&$("#bceSummaryDateOptions").val()!="Auto")e=$("#bceSummaryDateOptions").val();if(a=="Date"&&$("#bceSeriesDateOptions").val()!="Auto")e=$("#bceSeriesDateOptions").val();for(i=0;i<c.length;i++){switch(b){case "Simple":category="Simple";break;case "Group by client":category=
c[i].Client;break;case "Group by project":category=c[i].Project;break;case "Group by person":category=c[i].Person;break;case "Group by date":category=TimeGraph.ReportData.GetSeriesNameFromDate(e,c[i].Date);break}switch(a){case "Client":set=c[i].Client;break;case "Project":set=c[i].Project;break;case "Person":set=c[i].Person;break;case "ToDo":set=c[i].ToDo;break;case "Date":set=TimeGraph.ReportData.GetSeriesNameFromDate(e,c[i].Date);break}value=parseFloat(c[i].Hours);graphRow={Category:category,Set:set,
Value:value};if(d.length>0){bRowUpdated=false;for(iCounter=0;iCounter<d.length;iCounter++)if(d[iCounter].Category==graphRow.Category&&d[iCounter].Set==graphRow.Set){d[iCounter].Value+=parseFloat(graphRow.Value);bRowUpdated=true;break}bRowUpdated||d.push(graphRow)}else d.push(graphRow)}return d},ExtractData:function(){var b="",a="";TimeGraph.ReportData.Data=[];projectInfo=$("h1").html().split("<span>");b=jQuery.trim(projectInfo[0]);if(projectInfo.lenght>1)a=jQuery.trim(projectInfo[1].replace("</span>",
""));$("#entries tr").each(function(){if(!($(this).is(".blank_row_for_safari")||$(this).is("#new_time_entry")))if($(this).find(".project")[0]){projectInfo=$(this).find(".project").text().split(String.fromCharCode(8212));a=jQuery.trim(projectInfo[0]);b=jQuery.trim(projectInfo[1])}else{date=jQuery.trim($(this).find(".date").text());person=jQuery.trim($(this).find(".person").text());hours=jQuery.trim($(this).find(".hours").text());toDo=jQuery.trim($(this).find(".desc a").text());var c=/^(\w{3}\s\d\d)\s?(\d\d)?$/gi;
c.compile(c);if(c.test(date)){c.compile(c);c=c.exec(date);date=c.length>=3&&c[2]?c[1]+", 20"+c[2]:c[1]+", "+(new Date).getFullYear();dataRow={Client:a,Project:b,Date:new Date(date),Person:person,ToDo:toDo,Hours:hours};TimeGraph.ReportData.Data.push(dataRow)}}})}},ToggleOptions:function(){if($("#new_graph_option").is(":visible")){$("#new_graph_option").slideUp();setTimeout(function(){$("#original_header")[0].style.display=""},300)}else{$("#bceGraphDivWrapper").hide();$("#original_header")[0].style.display=
"none";$("#new_graph_option").slideDown()}},GenerateGraph:function(){TimeGraph.ReportData.ExtractData();summaryType=$("#bceGraphSummary").val();groupBy=$("#bceGraphSeries").val();graphData=TimeGraph.ReportData.SummarizeDataForGraph(summaryType,groupBy);TimeGraph.Graph.Caption=jQuery.trim($("#reporttitle").text());TimeGraph.Graph.Data=graphData;var b=$("#bceGraphType").val();$("#bceGraphDivWrapper").show();BasecampExt.TimeGraph.ToggleOptions();$("#bceGraphDiv").remove();$("#bceGraphDivWrapper").append('<canvas id="bceGraphDiv" style="width:100%;height:500px;"></canvas>');
grapType="bar";graphOptions={scales:{yAxes:[{ticks:{beginAtZero:true}}]},title:{display:true,text:TimeGraph.Graph.Caption},legend:{display:false}};switch(b){case "Column Chart":grapType="bar";break;case "Pie Chart":grapType="pie";graphOptions=null;break;case "Line Chart":grapType="line";break;case "Doughnut Chart":grapType="doughnut";graphOptions=null;break}var a=document.getElementById("bceGraphDiv");new Chart(a,{type:grapType,responsive:false,maintainAspectRatio:false,data:TimeGraph.Graph.getGraphJSONData(b),
options:graphOptions})},PopulateSeriesAndGraphType:function(){bceGraphSeries=$("#bceGraphSeries")[0];oldValue=bceGraphSeries.value;summaryType=$("#bceGraphSummary").val();bceGraphSeries.options.length=0;seriesOptionsArray=[];summaryType!="Group by client"&&seriesOptionsArray.push("Client");summaryType!="Group by project"&&seriesOptionsArray.push("Project");summaryType!="Group by person"&&seriesOptionsArray.push("Person");summaryType!="Group by date"&&seriesOptionsArray.push("Date");seriesOptionsArray.push("ToDo");
for(i=0;i<seriesOptionsArray.length;i++){var b=document.createElement("option");b.text=seriesOptionsArray[i];b.value=seriesOptionsArray[i];bceGraphSeries.add(b,null);if(seriesOptionsArray[i]==oldValue)bceGraphSeries.options[bceGraphSeries.length-1].selected=true}bceGraphType=$("#bceGraphType")[0];oldValue=bceGraphType.value;bceGraphType.options.length=0;graphOptionsArray=summaryType=="Simple"?["Column Chart","Pie Chart","Line Chart","Doughnut Chart"]:["Column 2D Chart","Column 3D Chart","Line 2D Chart",
"Bar 2D Chart","Area 2D Chart"];for(i=0;i<graphOptionsArray.length;i++){b=document.createElement("option");b.text=graphOptionsArray[i];b.value=graphOptionsArray[i];bceGraphType.add(b,null);if(graphOptionsArray[i]==oldValue)bceGraphType.options[bceGraphType.length-1].selected=true}if(summaryType=="Group by date"){$("#bceGraphSummary").width(118);$("#bceSummayDateOptionsSpan").show()}else{$("#bceGraphSummary").width(220);$("#bceSummayDateOptionsSpan").hide()}if($("#bceGraphSeries").val()=="Date"){$("#bceGraphSeries").width(118);
$("#bceSeriesDateOptionsSpan").show()}else{$("#bceGraphSeries").width(220);$("#bceSeriesDateOptionsSpan").hide()}},ApplyPreferences:function(){BasecampExt.Preferences.TimeGraph.Enabled?$("#bceCreateGraphLink").show():$("#bceCreateGraphLink").hide()},Initialize:function(){activePage=BasecampExt.Globals.GetActivePage();if(activePage=="Time"){graphHtmlLink=' <span id="bceCreateGraphLink"><span class="pipe">|</span> <a class="admin toggleGraphLink" href="#" id="create_time_graph">Create a graph</a></span>';
$(".page_header_links").first().html($(".page_header_links").first().html()+graphHtmlLink);$(".page_header").append('<div id="new_graph_option" class="new_time_report" style="display:none;width:100%"> \t\t\t  <div class="page_header_links"><a id="cancel_graph_link" href="#" class="donelink toggleGraphLink">Cancel graph creation</a></div> \t\t\t  <h1>Create a graph</h1> \t\t\t\t<div class="box_with_fields"> \t\t\t\t  <table> \t\t\t\t\t<tbody> \t\t\t\t\t<tr> \t\t\t\t\t  <th style="width:100px">Summary</th> \t\t\t\t\t  <td><select style="width:220px" id="bceGraphSummary"><option>Simple</option></select> \t\t\t\t\t  <span id="bceSummayDateOptionsSpan" style="display:none">By <select style="width:80" id="bceSummaryDateOptions"><option>Auto</option><option>Day</option><option>Week</option><option>Month</option><option>Quarter</option><option>Year</option></span>\t\t\t\t\t  </td> \t\t\t\t\t</tr> \t\t\t\t\t<tr> \t\t\t\t\t  <th style="width:100px">Series</th> \t\t\t\t\t  <td><select style="width:220px" id="bceGraphSeries"><option>Person</option></select> \t\t\t\t\t  <span id="bceSeriesDateOptionsSpan" style="display:none">By <select style="width:80" id="bceSeriesDateOptions"><option>Auto</option><option>Day</option><option>Week</option><option>Month</option><option>Quarter</option><option>Year</option></span> \t\t\t\t\t   </td> \t\t\t\t\t</tr> \t\t\t\t\t<tr>  \t\t\t\t\t  <th style="width:100px">Graph Type</th>  \t\t\t\t\t  <td><select style="width:220px" id="bceGraphType"><option>Column 3D Chart</option></select> \t\t\t\t\t   </td>  \t\t\t\t\t</tr>  \t\t\t\t  </tbody></table> \t\t\t\t</div> \t\t\t\t<p class="submit"><input type="button" value="Create graph" id="btnCreateGraph" name="btnCreateGraph"> or <a class="admin toggleGraphLink">Cancel</a></p> \t\t\t</div>');
$(".page_header").append('<div id="bceGraphDivWrapper" style="display:none" ><canvas id="bceGraphDiv" style="width:100%;height:500px;"></canvas></div>');BasecampExt.TimeGraph.PopulateSeriesAndGraphType();BasecampExt.TimeGraph.ApplyPreferences();$(".toggleGraphLink").click(function(){BasecampExt.TimeGraph.ToggleOptions();return false});$("#btnCreateGraph").click(function(){BasecampExt.TimeGraph.GenerateGraph()});$("#bceGraphSummary").change(function(){BasecampExt.TimeGraph.PopulateSeriesAndGraphType()});
$("#bceGraphSeries").change(function(){BasecampExt.TimeGraph.PopulateSeriesAndGraphType()})}}};BasecampExt.TimeGraph=TimeGraph;
