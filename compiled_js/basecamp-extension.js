var BasecampExt={Version:"0.3.1",PreferencesLoaded:false,TimeGraph:null,Preferences:{Disabled:false,TimeEntry:{DefaultDate:{Day:"--",Month:"--",Year:"--"},DefaultPerson:"",ParseTimeFromDescription:true,DescriptionStripString:" - ",SetLastChangeDateAsDefault:true},TimeGraph:{Enabled:true},Options:{TimeEntryIsVisible:true,TimeGraphIsVisible:false}},Browser:{AddEventListner:function(a,b,c,f){f=f||false;window.addEventListener?a.addEventListener(b,c,f):a.attachEvent("on"+b,c)},WaitAsynchSecure:function(a,
b,c){var f=window.setInterval(function(){var d=false;try{d=a()}catch(e){}if(d){window.clearInterval(f);b(c)}},50)},WaitAsynchDeprecated:function(a,b,c){var f=window.setInterval(function(){if((new Function("return "+a))()){window.clearInterval(f);b(c)}},50)}},Globals:{GetActivePage:function(){return $("#MainTabs").find(".current").text()}},TimeEntry:{ParseTime:function(a,b){b=new Date(b);var c=/^(\d\d?)[:-]?(\d\d?)[:-]?(\d\d?)*$/gi;c.compile(c);if(a=c.exec(a)){a.length>=2&&a[1]&&b.setHours(parseInt(a[1],
10));a.length>=3&&a[2]&&b.setMinutes(parseInt(a[2],10));a.length>=4&&a[3]&&b.setSeconds(parseInt(a[3],10))}return b},ParseDate:function(a){return new Date(a)},CalcTimeDuration:function(a,b){a=BasecampExt.TimeEntry.ParseTime(a,"7/6/1981");b=BasecampExt.TimeEntry.ParseTime(b,"7/6/1981");if(a.getHours()<13&&b.getHours()<13)a.getHours()>b.getHours()&&b.setHours(b.getHours()+12);else a.getHours()>b.getHours()&&b.setDay(b.getDay()+1);a=(b-a)/6E4;b=Math.floor(a/60);a=a%60;return b+":"+(a<10?"0":"")+a},ParseTimeAndDescription:function(a,
b){if(BasecampExt.Preferences.TimeEntry.ParseTimeFromDescription){var c=false,f=$(b["time_entry[description]"])[0];if(a)description=a&&a.clipboardData&&a.clipboardData.getData?a.clipboardData.getData("text/plain"):f.value;else{description=f.value;c=true}description=jQuery.trim(description);a=/^(\d\d?[:-]?\d\d?)\s*(?:[a|p]m)?\s+(\d\d?[:-]?\d\d?)\s*(?:[a|p]m)?\s+.*$/gi;a.compile(a);var d=a.exec(description);if(d&&d.length==3){a=d[1];d=d[2];var e=BasecampExt.TimeEntry.CalcTimeDuration(a,d);$(b["time_entry[hours]"]).val(e);
description=jQuery.trim(description.replace(a,"").replace(d,""));description=jQuery.trim(description.replace(/^\s*([a|p]m)?\s*([a|p]m)?/gi,""))}if(c&&description.indexOf(BasecampExt.Preferences.TimeEntry.DescriptionStripString)>0)description=jQuery.trim(description.substring(description.indexOf(BasecampExt.Preferences.TimeEntry.DescriptionStripString)+BasecampExt.Preferences.TimeEntry.DescriptionStripString.length));f.value=description}},ChangeDate:function(a,b){var c=$(a)[0];c=$(c.time_entry_date_display).val();
c=BasecampExt.TimeEntry.ParseDate(c);if(b=="next")c.setDate(c.getDate()+1);else b=="previous"&&c.setDate(c.getDate()-1);BasecampExt.Preferences.TimeEntry.DefaultDate.Day=c.getDate();BasecampExt.Preferences.TimeEntry.DefaultDate.Month=c.getMonth()+1;BasecampExt.Preferences.TimeEntry.DefaultDate.Year=c.getFullYear();BasecampExt.SavePreferences();BasecampExt.TimeEntry.TimeEntryLoaded(a,true)},TimeEntryLoaded:function(a,b){var c=$(a)[0];if(BasecampExt.Preferences.TimeEntry){var f=["Jan","Feb","Mar","Apr",
"May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(!b){var d=chrome.extension.getURL("");$(c).find(".date_pop_wrapper").parent().append("<div id='be_time_changer' style='margin: -24px 0px 10px 170px;width:12px;height:14px'><div id='be_prev_date' title='Previous Day' style='float:left;width:12px;cursor:pointer'><img src='"+d+"images/date_prev.gif' /></div><div id='be_next_date' title='Next Day' style='float:left;width:12px;margin-top:3px;cursor:pointer'><img src='"+d+"images/date_next.gif'></div></div>");
$(c).find("#be_prev_date").click(function(){BasecampExt.TimeEntry.ChangeDate(a,"previous")});$(c).find("#be_next_date").click(function(){BasecampExt.TimeEntry.ChangeDate(a,"next")})}if(d=BasecampExt.Preferences.TimeEntry.DefaultDate){var e=$(c.time_entry_date_display).val();e=BasecampExt.TimeEntry.ParseDate(e);d.Year!="--"&&e.setYear(d.Year);d.Month!="--"&&e.setMonth(d.Month-1);d.Day!="--"&&e.setDate(d.Day);$(c["time_entry[date]"]).val(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate());e=f[e.getMonth()]+
" "+e.getDate()+", "+e.getFullYear();$(c.time_entry_date_display).val(e)}BasecampExt.Preferences.TimeEntry.SetLastChangeDateAsDefault&&!b&&$(a).click(function(){if(BasecampExt.Preferences.TimeEntry.SetLastChangeDateAsDefault){var g=$(c.time_entry_date_display).val();if((g=BasecampExt.TimeEntry.ParseDate(g))&&g.getDate()){BasecampExt.Preferences.TimeEntry.DefaultDate.Day=g.getDate();BasecampExt.Preferences.TimeEntry.DefaultDate.Month=g.getMonth()+1;BasecampExt.Preferences.TimeEntry.DefaultDate.Year=
g.getFullYear();BasecampExt.SavePreferences()}}});var h=BasecampExt.Preferences.TimeEntry.DefaultPerson;h&&h.length>0&&$(c["time_entry[person_id]"]).find("option").each(function(){this.selected=jQuery.trim(this.text)==h});if(BasecampExt.Preferences.TimeEntry.ParseTimeFromDescription){$(c["time_entry[description]"])[0]&&window.setTimeout(function(){$(c["time_entry[description]"])[0].focus()},100);$(c["time_entry[description]"]).blur(function(g){BasecampExt.TimeEntry.ParseTimeAndDescription(g,c)});
$(c["time_entry[description]"]).bind("paste",function(){window.setTimeout(function(){BasecampExt.TimeEntry.ParseTimeAndDescription(null,c)},50)})}}},Initialize:function(){activePage=BasecampExt.Globals.GetActivePage();if(activePage=="To-Dos")$(document).click(function(a){if(!BasecampExt.Preferences.Disabled){var b=/^item_(\d+)_time_tracking_control$/gi;b.compile(b);if(a.target&&a.target.parentNode&&b.test(a.target.parentNode.id)){b.compile(b);timeEntryId=b.exec(a.target.parentNode.id)[1];$("#item_"+
timeEntryId+"_content form")[0]||BasecampExt.Browser.WaitAsynchDeprecated('$("#item_"+timeEntryId+"_content form")[0]',BasecampExt.TimeEntry.TimeEntryLoaded,"#item_"+timeEntryId+"_content form")}}});else if(activePage=="Time"){BasecampExt.Browser.WaitAsynchDeprecated('$("#entry_adder")[0]',BasecampExt.TimeEntry.TimeEntryLoaded,"#entry_adder");$("#entry_adder :submit").click(function(){BasecampExt.Browser.WaitAsynchDeprecated('$("#entry_adder :submit").val() != "Adding to log"',BasecampExt.TimeEntry.TimeEntryLoaded,
"#entry_adder")})}}},SavePreferences:function(){chrome.extension.sendRequest({message:"Extension_SavePreferences",preferences:BasecampExt.Preferences})},LoadPreferences:function(){chrome.extension.sendRequest({message:"Extension_LoadPreferences"},function(a){if(a&&a.preferences){BasecampExt.Preferences.Disabled=a.preferences.Disabled;BasecampExt.Preferences.TimeEntry.DefaultDate=a.preferences.TimeEntry.DefaultDate;BasecampExt.Preferences.TimeEntry.DefaultPerson=a.preferences.TimeEntry.DefaultPerson;
BasecampExt.Preferences.TimeEntry.ParseTimeFromDescription=a.preferences.TimeEntry.ParseTimeFromDescription;BasecampExt.Preferences.TimeEntry.DescriptionStripString=a.preferences.TimeEntry.DescriptionStripString;if(a.preferences.TimeEntry.SetLastChangeDateAsDefault!=null)BasecampExt.Preferences.TimeEntry.SetLastChangeDateAsDefault=a.preferences.TimeEntry.SetLastChangeDateAsDefault;if(a.preferences.TimeGraph)BasecampExt.Preferences.TimeGraph=a.preferences.TimeGraph;if(a.preferences.Options)BasecampExt.Preferences.Options=
a.preferences.Options}BasecampExt.PreferencesLoaded=true;chrome.extension.sendRequest({message:"ShowPageAction",extensionEabled:!BasecampExt.Preferences.Disabled});BasecampExt.TimeGraph&&BasecampExt.TimeGraph.ApplyPreferences()})},Initialize:function(){this.TimeEntry.Initialize();BasecampExt.Browser.WaitAsynchSecure(function(){return BasecampExt.TimeGraph},function(){BasecampExt.TimeGraph.Initialize()});this.LoadPreferences()}};BasecampExt.Initialize();
